datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Status {
  ONLINE
  OFFLINE
}

model User {
  id                  String               @id @default(auto()) @map("_id") @db.ObjectId
  phone               String               @unique
  userName            String               @map("user_name")
  profilePictureUrl   String?              @map("profile_picture_url")
  status              Status
  lastActiveAt        DateTime?            @map("last_active_at")
  sentMessages        Message[]            @relation("SentMessages")
  conversationMembers ConversationMember[]
  adminChannels       Channel[]            @relation("AdminChannels")
  superAdminChannels  Channel[]            @relation("SuperAdminChannels")
  CreatedChannels     Channel[]            @relation("CreatedChannels")
  channelMembers      ChannelMember[]
  groupMembers        GroupMember[]
  CreatedGroups       Group[]              @relation("CreatedGroups")
  contacts            Contact[]            @relation("UserContacts")
  addedContacts       Contact[]            @relation("AddedContacts")
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  @@map("users")
}

model Conversation {
  id           String               @id @default(auto()) @map("_id") @db.ObjectId
  members      ConversationMember[]
  messages     Message[]
  lastMessage  LastMessage?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  lastActivity DateTime             @default(now())

  @@map("conversations")
}

model ConversationMember {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  user           User         @relation(fields: [userId], references: [id])
  userId         String       @db.ObjectId
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  conversationId String       @db.ObjectId
  joinedAt       DateTime     @default(now())

  @@unique([userId, conversationId])
  @@map("conversation_members")
}

model Group {
  id                String        @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  description       String?
  isPublic          Boolean       @default(false) // Whether the group is open to anyone
  profilePictureUrl String?       @map("profile_picture_url")
  messages          Message[]
  lastMessage       LastMessage?
  createdBy         User          @relation("CreatedGroups", fields: [createdById], references: [id])
  createdById       String        @db.ObjectId
  members           GroupMember[]
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  lastActivity      DateTime      @default(now())

  @@map("groups")
}

model GroupMember {
  id       String   @id @default(auto()) @map("_id") @db.ObjectId
  user     User     @relation(fields: [userId], references: [id])
  userId   String   @db.ObjectId
  group    Group    @relation(fields: [groupId], references: [id])
  groupId  String   @db.ObjectId
  joinedAt DateTime @default(now())

  @@unique([userId, groupId])
  @@map("group_members")
}

model Message {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  sender         User          @relation("SentMessages", fields: [senderId], references: [id])
  senderId       String        @db.ObjectId
  content        String
  photoUrl       String[]
  fileUrls       String[]
  conversation   Conversation? @relation(fields: [conversationId], references: [id])
  conversationId String?       @db.ObjectId
  channel        Channel?      @relation(fields: [channelId], references: [id])
  channelId      String?       @db.ObjectId
  group          Group?        @relation(fields: [groupId], references: [id])
  groupId        String?       @db.ObjectId // If this is set, it's a group message
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@map("messages")
}

model Channel {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  description       String?
  isPublic          Boolean         @default(true)
  profilePictureUrl String?         @map("profile_picture_url")
  messages          Message[]
  lastMessage       LastMessage?
  createdBy         User            @relation("CreatedChannels", fields: [createdById], references: [id])
  createdById       String          @db.ObjectId
  superAdmin        User            @relation("SuperAdminChannels", fields: [superAdminId], references: [id])
  superAdminId      String          @db.ObjectId
  admin             User            @relation("AdminChannels", fields: [adminIds], references: [id])
  adminIds          String[]        @db.ObjectId
  members           ChannelMember[]
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  lastActivity      DateTime        @default(now())

  @@map("channels")
}

model ChannelMember {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @db.ObjectId
  channel   Channel  @relation(fields: [channelId], references: [id])
  channelId String   @db.ObjectId
  joinedAt  DateTime @default(now())

  @@unique([userId, channelId])
  @@map("channel_members")
}

model Contact {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  user   User   @relation("UserContacts", fields: [userId], references: [id])
  userId String @db.ObjectId

  contact   User     @relation("AddedContacts", fields: [contactId], references: [id])
  contactId String   @db.ObjectId
  createdAt DateTime @default(now())

  @@unique([userId, contactId])
  @@map("contacts")
}

type LastMessage {
  content   String
  senderId  String   @db.ObjectId
  createdAt DateTime
}
